from bluepy import btle
import paho.mqtt.client as mqtt
import argparse
import time
import math

#DEVICE_NAME = 'RN079D'
#
#MAC_ADDRESS = None
#SERVICE_UUID = '11223344-5566-7788-9900-aabbccddeeff'
#CHARACTERISTIC_UUID = '01020304-0506-0708-0900-0a0b0c0d0e0f'

TOPIC = "sensor"
COMMAND = "command"

parser = argparse.ArgumentParser()
parser.add_argument("-i", "--interface",
                            help="BLE interface number (hcix)", type=int, default=0)
parser.add_argument("-d", "--device_name", help="BLE device name")
parser.add_argument("-s", "--service_uuid", help="Service UUID")
parser.add_argument("-t", "--tx_characteristic_uuid", help="TX characteristic UUID")
parser.add_argument("-r", "--rx_characteristic_uuid", help="RX characteristic UUID")
args = parser.parse_args()

def timestamp():
    return math.floor(time.time()*1000)/1000

class EdgeAiDelegate(btle.DefaultDelegate):
    '''
    Edge AI delegate to receive NOTIFY.
    '''

    def __init__(self, device_name, client, topic):
        btle.DefaultDelegate.__init__(self)
        self.device_name = device_name
        self.mqtt_client = client
        self.mqtt_topic = topic

    def handleNotification(self, cHandle, data):
        #print('handle: {}'.format(cHandle))
        inference_result = int.from_bytes(data, 'little', signed=False)
        print(inference_result)
        msg = "{},{:.3f},{}".format(self.device_name, timestamp(), inference_result)
        self.mqtt_client.publish(self.mqtt_topic, msg)

class EdgeAiInterface():

    def __init__(self, conn, tx_chara_uuid, rx_chara_uuid):
        self.conn = conn
        self.tx_chara_uuid = tx_chara_uuid
        self.rx_chara_uuid = rx_chara_uuid
        self.write_handle = self.conn.getCharacteristics(uuid=rx_chara_uuid)[0].getHandle()

    def enable_notify(self):
        '''
        Enable NOTIFY on the target characteristic.
        '''
        setup_data = b"\x01\x00"
        notify = self.conn.getCharacteristics(uuid=self.tx_chara_uuid)[0]
        notify_handle = notify.getHandle() + 1
        self.conn.writeCharacteristic(notify_handle, setup_data, withResponse=True)

    def on_message(self, client, userdata, message):
        cmd = str(message.payload.decode("utf-8")).encode('utf8')
        print(cmd)
        # send the command to a BLE peripheral
        self.conn.writeCharacteristc(self.write_handle, cmd, withResponse=True)

if __name__ == '__main__':

    scanner = btle.Scanner(args.interface)
    devices = scanner.scan(3.0)


    for device in devices:

        mac_address = None
        # Search for the device name
        for (adTypeCode, description, valueText) in device.getScanData():
            if valueText == args.device_name:
                #print(device.addr)
                print(device.addrType)
                #print(device.rssi)
                print(adTypeCode, description, valueText)
                mac_address = device.addr

        if mac_address: # If found
            peripheral = btle.Peripheral()
            if device.addrType == 'random':
                peripheral.connect(mac_address, btle.ADDR_TYPE_RANDOM) 
            else:
                peripheral.connect(mac_address) 
            peripheral.withDelegate(EdgeAiDelegate(args.device_name,
                                                client, TOPIC))

            for service in peripheral.getServices():
                if service.uuid == args.service_uuid:
                    print('--- services and characteristics ---')
                    for characteristic in service.getCharacteristics():
                        print(characteristic.uuid)
                        print(characteristic.getHandle())
                        print(characteristic.propertiesToString()) 
                        pass

            interface = EdgeAiInterface(peripheral, args.tx_characterstic_uuid,
                    args.rx_characteristc_uuid)
            interface.enable_notify()

            # MQTT 
            client = mqtt.Client("ble-router-interface{}".format(args.device_name))
            client.connect("localhost")
            client.on_message = interface.on_message
            client.subscribe(COMMAND)
            client.loop_start()

            while True:
                if peripheral.waitForNotifications(1.0):
                    #print("Notification")
                    continue
