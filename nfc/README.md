# Dynamic NFC/RFID tag (STMicro's ST25DV04K) with RN4020

## Application abstract

RN4020 as a BLE module receives URI write requests from a BLE central (RasPi), and transfer the requests to STM32. STM32 writes the URI to NFC tag via I2C everytime it receives a request.

Pushing rich user interface to the user's smartphone via NFC tag:
```
                                                                          Dynamic NFC tag
    [RasPi (BLE central)]---BLE--->[RN4020(BLE peripheral)][STM32]---I2C--->[ST25DV04K]---NFC--->[Smart phone]

```

Bi-directonal communication with MCU via NFC (WiFi/BLE not involved):
```
                         Local event
                              |
                              V                                  Dynamic NFC tag
    [RN4020(BLE peripheral)][STM32]---I2C--->[ST25DV04K]---NFC--->[Smart phone]

    [RN4020(BLE peripheral)][STM32]<--I2C----[ST25DV04K]<--NFC----[Smart phone]
                              ^                  GPO
                              |                   |
                              +-------------------+
                                   Interrupt
```

## Dynamic NFC tag

A MCU can communicate with a smart phone via dynamic NFC tag. The chip "ST25DV04K" supports bi-directional communication in a passive way, so it can be thought of a reader/writer powerd by a smartphone via RF. Adopt dynamic NFC tag instead of LCD!

- [X-NUCLEO-NFC04A1](https://www.st.com/en/ecosystems/x-nucleo-nfc04a1.html)
- [ST25DV04K(Dynamic NFC tag)](https://www.st.com/en/nfc/st25dv04k.html)
- ["NFC Tap" Android app for ST25](https://www.st.com/content/st_com/en/products/embedded-software/st25-nfc-rfid-software/stsw-st25001.html)
- [ST25 SDK(jar)](https://my.st.com/content/my_st_com/en/products/embedded-software/st25-nfc-rfid-software/stsw-st25sdk001.html)
- [ST25 Webapp(html5)](https://smarter.st.com/st25-nfc-web-application/?icmp=tt7281_gl_lnkon_may2018)

### ST25DV04K

- 256 bytes buffer for fast transfer
- 4Kbits EEPROM

## URI write request to the device (BLE write request)

The implementation in this device application follows the BLE characteristics defined in [this page](https://github.com/araobp/iot-wireless/tree/master/gateway/BLE).

```
     +-----------------------+
     |  NDEF URL identifier  |
     +-----------------------+
     |  ','                  |
     +-----------------------+
     |  URI field[0]         |
     +-----------------------+
     |  URI field[1]         |
     +-----------------------+
     |       :               |
     |       :               |
     +-----------------------+
     |  URI field[n]         |
     +-----------------------+
     |  '\n'                 |
     +-----------------------+

```

Example: 3,amazon.co.jp\n

Due to the limitation of BLE payload size (max. 20bytes), the request message is split into multiple data.

TODO: support multiple URIs

## URI read request to the device (BLE write request)

```
     +-----------------------+
     |  '0'                  |
     +-----------------------+
```

When the beginning character is '0', the request message is regarded as "read URI from the NFC tag".

 
TODO: support multiple URIs

## Collision problem

I was going to use USART1 for RN4020, but USART1's RX (PA10) is already used by X-CUBE-NFC4/X-NUCLEO-NFC05A1 for YELLOW LED.

So I use USART6 instead.

## A bug in X-CUBE-NFC4/CubeMX

BSP folder is removed whenever code is generated by CubeMX after the initial generation. Copy BSP into the folder manually to cope with the problem.
